"""
üöÄ UltraBTC HYBRID v1.4 FIXED - ENHANCED EDITION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ú® –ù–û–í–û–ï –í v1.3:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
   - ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù DCA –¥–ª—è SHORT (—Ç–µ–ø–µ—Ä—å —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –í–´–®–ï –≤—Ö–æ–¥–∞)
   - ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TP –æ—Ç ATR –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
   - ‚úÖ PnL Audit (–¥–µ—Ç–µ–∫—Ç–æ—Ä –æ—à–∏–±–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤)
   - ‚úÖ Blackbox JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)
   - ‚úÖ Future Spy (–∞–Ω–∞–ª–∏–∑ —É–ø—É—â–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏)

üéØ –ò–ó v1.1:
   - AI —á–∞—Ç –≤ Telegram
   - 7 –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
   - Confluence scoring (0-7)
   - –£–º–Ω–∞—è DCA —Å–µ—Ç–∫–∞ –∏–∑ ultrabtc7

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""

import os

# üîë API KEYS
AI_GEMINI_KEY = os.getenv("GEMINI_API_KEY", "AIzaSyDHrTaNZo8pR55GNmYLASC3yKtx-Y1HRcU")
AI_MODEL_NAME = "gemini-1.5-flash"  # –°—Ç–∞–±–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞
TG_BOT_TOKEN = ""

HAS_AI = True

SYMBOL = 'BTC/USDT:USDT'
TIMEFRAME = '1m'

FUNDING_RATE_8H = 0.0001 

# üí∞ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ü–ò–¢–ê–õ–û–ú
LEVERAGE = 20                
ALLOWED_CAPITAL_PCT = 0.5

# üî• –ì–ò–ë–†–ò–î–ù–´–ô –í–•–û–î (3 —Å—Ç–∞–¥–∏–∏)
# Stage 1: –°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª (confluence 0-2)
STAGE1_MIN_ENTRY = 0.008
STAGE1_BASE_ENTRY = 0.012
STAGE1_MAX_ENTRY = 0.016

# Stage 2: –°—Ä–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª (confluence 3-4)
STAGE2_MIN_ENTRY = 0.013
STAGE2_BASE_ENTRY = 0.018
STAGE2_MAX_ENTRY = 0.023

# Stage 3: –°–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª (confluence 5+)
STAGE3_MIN_ENTRY = 0.018
STAGE3_BASE_ENTRY = 0.025
STAGE3_MAX_ENTRY = 0.030

# üî® –°–ï–¢–ö–ê (–∏–∑ ultrabtc7 - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô!)
SAFETY_ORDERS_COUNT = 5      
MIN_EXCHANGE_ORDER_USD = 5.1 

# –î–∏—Å—Ç–∞–Ω—Ü–∏–∏ (–∏–∑ ultrabtc7)
HAMMER_DISTANCES_TREND = [0.006, 0.012, 0.020, 0.030, 0.045]
HAMMER_DISTANCES_RANGE = [0.010, 0.018, 0.030, 0.045, 0.065]

# –í–µ—Å–∞ (–∏–∑ ultrabtc7)
HAMMER_WEIGHTS_TREND = [1.4, 2.0, 2.8, 3.5, 4.5]
HAMMER_WEIGHTS_RANGE = [1.6, 2.2, 3.0, 4.0, 5.0]

# üéØ –í–´–•–û–î (–∏–∑ ultrabtc7 - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô!)
TP_STEPS_HIGH_VOL = [0.0070, 0.0060, 0.0050, 0.0040, 0.0030]  
TP_STEPS_MED_VOL = [0.0060, 0.0050, 0.0040, 0.0035, 0.0030]   
TP_STEPS_LOW_VOL = [0.0050, 0.0040, 0.0035, 0.0030, 0.0025]   

# üîÑ TREND TRAILING - –ì–∏–±—Ä–∏–¥–Ω—ã–π –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π (v1.4.2)
TRAILING_ENABLED = True
TRAILING_UPDATE_INTERVAL = 3

# –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è (–±–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –¥–æ TP)
TREND_TRAILING_ACTIVATION_RATIO = 0.5  # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ 50% –ø—É—Ç–∏ –∫ TP

# –ü–æ—Ä–æ–≥ –æ—Ç–∫–∞—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (% –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ TP)
TREND_TRAILING_CALLBACK_RATIOS = {
    'high_vol': 0.25,    # >0.4% –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –æ—Ç–∫–∞—Ç = 25% –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ TP
    'medium_vol': 0.20,  # 0.25-0.4%: –æ—Ç–∫–∞—Ç = 20%
    'low_vol': 0.15      # <0.25%: –æ—Ç–∫–∞—Ç = 15%
}

# –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
TREND_TRAILING_ACTIVATION_VOL_ADJUST = {
    'high_vol': 1.2,     # +20% –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ–∑–∂–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è)
    'medium_vol': 1.0,   # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    'low_vol': 0.8       # -20% –ø—Ä–∏ –Ω–∏–∑–∫–æ–π (—Ä–∞–Ω—å—à–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è)
}       

# üõ°Ô∏è –ó–ê–©–ò–¢–ê
MAX_ACCOUNT_LOSS_PCT = 0.30    

# üìä –ì–ò–ë–†–ò–î–ù–´–ï –§–ò–õ–¨–¢–†–´
QUALITY_FILTER_ENABLED = True
MIN_VOLATILITY_PCT = 0.0003
MIN_VOLUME_RATIO = 1.0
RSI_SAFE_MIN = 30
RSI_SAFE_MAX = 70
KNIFE_PROTECTION_PCT = 0.015
MIN_MICROTREND_CANDLES = 1

# üéØ CONFLUENCE –°–ò–°–¢–ï–ú–ê
MIN_CONFLUENCE_SCORE = 1
CONFLUENCE_STAGE1_MAX = 2
CONFLUENCE_STAGE2_MAX = 4

# ‚è≥ –¢–ê–ô–ú–ï–† –û–•–õ–ê–ñ–î–ï–ù–ò–Ø
MIN_TIME_BETWEEN_TRADES = 3600
DAILY_TRADE_LIMIT = 150

# üí∏ –ö–û–ú–ò–°–°–ò–ò
MAKER_FEE = 0.0002
TAKER_FEE = 0.0005

# üéØ RANGE TRAILING - –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ (v1.4.2)
# –§–æ—Ä–º–∞—Ç: (–º–∞–∫—Å_–ø—Ä–æ—Ñ–∏—Ç_–¥–ª—è_–ø–æ—Ä–æ–≥–∞, –ø–æ—Ä–æ–≥_–æ—Ç–∫–∞—Ç–∞)
RANGE_TRAILING_THRESHOLDS = [
    (0.003, 0.0010),  # –î–æ +0.3% –ø—Ä–∏–±—ã–ª–∏: –æ—Ç–∫–∞—Ç 0.10% (—Å–≤–æ–±–æ–¥–Ω–æ, –¥–∞—ë–º —Ä–∞—Å—Ç–∏)
    (0.005, 0.0007),  # –û—Ç +0.3% –¥–æ +0.5%: –æ—Ç–∫–∞—Ç 0.07% (—Å—Ä–µ–¥–Ω—è—è —Ñ–∏–∫—Å–∞—Ü–∏—è)
    (999, 0.0005)     # –í—ã—à–µ +0.5%: –æ—Ç–∫–∞—Ç 0.05% (–∂—ë—Å—Ç–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –ø—Ä–∏–±—ã–ª–∏)
]

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ TP (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –±–∏—Ä–∂—É)
RANGE_TRAILING_TP_UPDATE_THRESHOLD = 0.001  # 0.1% - –æ–±–Ω–æ–≤–ª—è—Ç—å TP —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∏–∫–∞

# üõ°Ô∏è –£–ú–ù–ê–Ø –ó–ê–©–ò–¢–ê DCA (v1.4.3) - –£—Å–ª–æ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# –ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–µ, –Ω–µ –Ω–∞ –∫–∞–∂–¥—ã–π %!

# –ü–æ—Ä–æ–≥ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–∞—â–∏—Ç—ã (0.0 - 1.0)
PROTECTION_DANGER_THRESHOLD = 0.3  # –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 30% –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

# –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å –∑–∞—â–∏—Ç—ã: +N% –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –∑–∞ –∫–∞–∂–¥—ã–π 1% –í–ó–í–ï–®–ï–ù–ù–û–ô –ø—Ä–æ—Å–∞–¥–∫–∏
PROTECTION_AGGRESSION = 0.20  # 20% = +20% –∫ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –∑–∞ –∫–∞–∂–¥—ã–π 1% –æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–∏

# –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–∞—â–∏—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏)
PROTECTION_DECAY_RATE = 0.008  # 0.8% –∑–∞ —Ü–∏–∫–ª (–ì–ò–ë–†–ò–î–ù–´–ô: –±—ã—Å—Ç—Ä–µ–µ –≤–æ–∑–≤—Ä–∞—Ç)

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–±–µ–∑ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Å–∞–¥–æ–∫) –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ DCA –±–ª–∏–∂–µ
PROTECTION_MIN_SAFE_TIME = 300  # 5 –º–∏–Ω—É—Ç (–ì–ò–ë–†–ò–î–ù–´–ô: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è BTC)

# –ü–æ—Ä–æ–≥ —Å–Ω–∏–∂–µ–Ω–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
PROTECTION_VOLATILITY_RATIO = 0.7  # ATR –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å –¥–æ 70% –æ—Ç –ø–∏–∫–∞

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
PROTECTION_RECOVERY_MIN = 0.30  # 30% –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ—Å–∞–¥–∫–∏ (–ì–ò–ë–†–ò–î–ù–´–ô: —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–µ–µ)

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∏–∑ 5)
PROTECTION_MIN_CHECKS = 3  # 3 –∏–∑ 5 –ø—Ä–æ–≤–µ—Ä–æ–∫ (–ì–ò–ë–†–ò–î–ù–´–ô: –≥–∏–±–∫–∏–π –±–∞–ª–∞–Ω—Å)

# –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
PROTECTION_SPEED_DROP_THRESHOLD = 0.01  # 1% –ø–∞–¥–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç = –æ–ø–∞—Å–Ω–æ
PROTECTION_CANDLES_LOOKBACK = 10  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ –∑–∞ 10 —Å–≤–µ—á–µ–π
PROTECTION_DIRECTIONAL_CANDLES = 3  # 3+ —Å–≤–µ—á–∏ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É = –æ–ø–∞—Å–Ω–æ—Å—Ç—å
PROTECTION_ATR_STABLE_RATIO = 0.8  # ATR >80% —Å—Ä–µ–¥–Ω–µ–≥–æ = —Ä–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è

# –§–ê–ô–õ–´
LOG_FILE = "bot_hybrid.log"
CSV_FILE = "trades_hybrid.csv"
MARKET_LOG_FILE = "market_hybrid.csv"
SECRETS_FILE = "encrypted_config.bin"
KEY_FILE = "secret.key"

class Col:
    WHITE = '\033[97m'    # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û!
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    CYAN = '\033[96m'
    BLUE = '\033[94m'
    RESET = '\033[0m'
    BOLD = '\033[1m'
    MAGENTA = '\033[95m'
    GRAY = '\033[90m'
