# üìö –°–ü–†–ê–í–û–ß–ù–ò–ö –í–°–ï–• –§–£–ù–ö–¶–ò–ô –ë–û–¢–ê

**–î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –¥—Ä—É–≥—É—é —Å–µ—Å—Å–∏—é Claude**

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–¥–∞ –≤ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏.

---

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í

```
main.py              - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
config.py            - –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
trading_bot.py       - –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞ (2428 —Å—Ç—Ä–æ–∫)
telegram_bot.py      - Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
ai_assistant.py      - AI –ø–æ–º–æ—â–Ω–∏–∫ (Gemini)
security.py          - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π
```

---

## ü§ñ trading_bot.py - –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° (39 —Ñ—É–Ω–∫—Ü–∏–π)

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

#### `__init__(self, exchange, tg, ai_key=None, ai_model_name=None)`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏—Ä–∂–∏, Telegram, AI
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### `log(self, msg, color=None)`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å —Å —Ü–≤–µ—Ç–æ–º
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª `bot_hybrid.log`

#### `log_blackbox(self, event_type, data)`
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ JSON
- –§–æ—Ä–º–∞—Ç: `blackbox_YYYYMMDD_HHMMSS.json`
- –°–æ–±—ã—Ç–∏—è: ENTRY, DCA, TP, SL, TRAILING

---

### 2. –†–∞–±–æ—Ç–∞ —Å —Ä—ã–Ω–∫–æ–º

#### `get_market_data_enhanced(self)`
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ—á–µ–π —Å –±–∏—Ä–∂–∏ (200 —Å–≤–µ—á–µ–π √ó 1m)
- –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: EMA9, EMA15, EMA20, RSI, ATR, ADX, BB
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞: `is_trending_market` (ADX > 25)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç DataFrame

#### `calculate_confluence_score(self, df)`
- –û—Ü–µ–Ω–∫–∞ —Å–∏–ª—ã —Å–∏–≥–Ω–∞–ª–∞ –ø–æ 7 —Ñ–∞–∫—Ç–æ—Ä–∞–º
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0-7 –±–∞–ª–ª–æ–≤
- –§–∞–∫—Ç–æ—Ä—ã: RSI, EMA —Ç—Ä–µ–Ω–¥, momentum, –æ–±—ä—ë–º, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ

#### `check_entry_signal_hybrid(self, df)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ 7 —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤—Ö–æ–¥–∞:
  1. EMA –∫—Ä–æ—Å—Å–æ–≤–µ—Ä (EMA9 vs EMA15)
  2. Momentum (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ EMA9)
  3. –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (ATR > 0.03%)
  4. RSI –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (30 < RSI < 70)
  5. –û–±—ä—ë–º (Volume Ratio > 1.0)
  6. –ú–∏–∫—Ä–æ—Ç—Ä–µ–Ω–¥ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–≤–µ—á–∞–º–∏)
  7. –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–æ–∂–∞ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ < 1.5%)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{'signal': 'Buy'/'Sell', 'stage': 1/2/3, 'confluence': 0-7}`

---

### 3. –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏

#### `calculate_smart_position_size_hybrid(self, df, stage)`
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤—Ö–æ–¥–∞
- –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ —Å—Ç–∞–¥–∏–∏ (Stage 1/2/3)
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ ATR –∏ ADX (score: -2 –¥–æ +2)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –±–∞–ª–∞–Ω—Å–∞ (0.008 - 0.030)

#### `get_dca_parameters(self)`
- –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ DCA –ø–æ —Ä–µ–∂–∏–º—É
- TREND: distances=[0.6%, 1.2%, 2%, 3%, 4.5%], weights=[1.4, 2.0, 2.8, 3.5, 4.5]
- RANGE: distances=[1%, 1.8%, 3%, 4.5%, 6.5%], weights=[1.6, 2.2, 3.0, 4.0, 5.0]

#### `get_smart_distance_multiplier(self, safety_count)`
- **–ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø**: –£–º–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è DCA
- –§–æ—Ä–º—É–ª–∞: `ATR_factor √ó RSI_factor √ó GEO_factor`
- ATR_factor: current_ATR / 0.002, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω [0.8, 2.5]
- RSI_factor: 1.0-1.6 –¥–ª—è –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (RSI < 40)
- GEO_factor: 1.1 ^ safety_count (–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ DCA

---

### 4. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TP

#### `get_dynamic_tp_steps(self)`
- –†–∞—Å—á–µ—Ç TP –æ—Ç —Ç–µ–∫—É—â–µ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
- –§–æ—Ä–º—É–ª–∞: `0.35% + (ATR √ó 0.5)`
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: [0.25%, 1.0%]
- –ü—Ä–∏–º–µ—Ä: ATR 0.4% ‚Üí TP = 0.55%

---

### 5. –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏

#### `open_position(self, signal_data)`
- **–ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø** –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
- –®–∞–≥–∏:
  1. –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ (`calculate_smart_position_size_hybrid`)
  2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã (bid/ask)
  3. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
  4. –û–∂–∏–¥–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (30 —Å–µ–∫)
  5. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏
  6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (avg_price, size, confluence, stage)
  7. –†–∞–∑–º–µ—â–µ–Ω–∏–µ TP, DCA, Stop Loss
  8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
  9. Blackbox –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### 6. Take Profit

#### `place_limit_tp(self)`
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ TP –æ—Ä–¥–µ—Ä–∞
- –¶–µ–Ω–∞: `avg_price √ó (1 + dynamic_tp)`
- –û—Ç–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π TP –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ DCA!**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (v1.4.1)

---

### 7. DCA (—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ)

#### `place_limit_dca(self)`
- **–ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø**: –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ DCA
- –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (`_dca_placing` —Ñ–ª–∞–≥)
- –†–∞—Å—á–µ—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏: `base_dist √ó get_smart_distance_multiplier()`
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
  - LONG: DCA –ù–ò–ñ–ï –≤—Ö–æ–¥–∞ (`base_entry_price √ó (1 - actual_dist)`)
  - SHORT: DCA –í–´–®–ï –≤—Ö–æ–¥–∞ (`base_entry_price √ó (1 + actual_dist)`) ‚úÖ v1.3
- –†–∞–∑–º–µ—Ä: `entry_usd_vol √ó weight √ó leverage`
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (v1.4.1)

#### `execute_dca(self, fill_price, fill_amount, order_id)`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ DCA
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
  - `safety_count += 1`
  - `total_size_coins += fill_amount`
  - `avg_price = weighted_average(prev, new)` (–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—Ä–µ–¥–Ω—è—è!)
  - `current_trade_fees += dca_fee`
- **–í–ê–ñ–ù–û**: –í—ã–∑—ã–≤–∞–µ—Ç `place_limit_tp()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è TP!
- –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç `place_stop_loss()` ‚Äî SL –æ—Å—Ç–∞–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
- Blackbox –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

### 8. Stop Loss

#### `place_stop_loss(self)`
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –±–∏—Ä–∂–µ–≤–æ–≥–æ Stop Loss –æ—Ä–¥–µ—Ä–∞
- ‚ö†Ô∏è **–ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–û–†–ú–£–õ–ê**: `sl_price = avg_price √ó (1 - 0.30)`
- –≠—Ç–æ -30% –æ—Ç –¶–ï–ù–´, –∞ –Ω–µ –æ—Ç –ë–ê–õ–ê–ù–°–ê!
- **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ DCA!**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ backup –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–≤—è–∑–∏

#### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ main_loop)
```python
# –ö–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
max_loss = balance √ó 0.30
u_pnl = (current_price - avg_price) √ó size √ó side_mult
if u_pnl <= -max_loss:
    close_position_market("STOP LOSS -30%")
```
- –≠—Ç–æ **–ü–†–ê–í–ò–õ–¨–ù–ê–Ø** –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞!
- –†–∞–±–æ—Ç–∞–µ—Ç –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç –±–∏—Ä–∂–µ–≤–æ–≥–æ –æ—Ä–¥–µ—Ä–∞

---

### 9. Trailing Stop

#### `check_trailing_stop(self)`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ trailing stop
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è: unrealized_pnl >= +0.8%
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∏–∫–∞: –ø—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ: –æ—Ç–∫–∞—Ç -0.35% –æ—Ç –ø–∏–∫–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: True –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª (–ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞)

#### `reset_trailing(self)`
- –°–±—Ä–æ—Å trailing –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
- `trailing_active = False`
- `trailing_peak_price = 0.0`

---

### 10. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏

#### `close_position_market(self, reason)`
- **–ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø** –∑–∞–∫—Ä—ã—Ç–∏—è
- –®–∞–≥–∏:
  1. –û—Ç–º–µ–Ω–∞ –≤—Å–µ—Ö –æ—Ä–¥–µ—Ä–æ–≤ (TP, DCA, SL)
  2. –†—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä reduceOnly=True
  3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏
  4. –†–∞—Å—á–µ—Ç PnL:
     - `gross_pnl = (exit_price - avg_price) √ó size √ó side_mult`
     - `net_pnl = gross_pnl - total_fees`
  5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (wins/losses)
  6. Blackbox, CSV –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  7. Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  8. Future Spy (–µ—Å–ª–∏ SL)
  9. Cooldown (–µ—Å–ª–∏ SL)
  10. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### `cancel_all_orders(self)`
- –û—Ç–º–µ–Ω–∞ TP, DCA, SL –æ—Ä–¥–µ—Ä–æ–≤
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏

---

### 11. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π

#### `_sync_position_with_exchange(self)`
- **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω—ã (LONG/SHORT)
  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ avg_price, size
  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ safety_count (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ entry_usd_vol
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–∏—Ä–∂–µ–π (–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è?):
  - –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞
  - Emergency —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

### 12. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞–º–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ main_loop:
```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
open_orders = exchange.fetch_open_orders(symbol)
oids = [str(o['id']) for o in open_orders]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DCA
if dca_order_id and str(dca_order_id) not in oids:
    check = exchange.fetch_order(dca_order_id, symbol)
    if check['status'] == 'closed':
        execute_dca(price, amount, order_id)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ TP
if tp_order_id and str(tp_order_id) not in oids:
    check = exchange.fetch_order(tp_order_id, symbol)
    if check['status'] == 'closed':
        close_position_market("TP Hit")
```

**v1.4.1**: –í—Å–µ ID –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è!

---

### 13. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `refresh_wallet_status(self, notify=False)`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å –±–∏—Ä–∂–∏
- `balance = exchange.fetch_balance()['USDT']['total']`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ peak_balance

#### `get_effective_balance(self)`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `balance √ó ALLOWED_CAPITAL_PCT`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100% –±–∞–ª–∞–Ω—Å–∞

#### `get_real_order_fee(self, order_id)`
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ —Å –±–∏—Ä–∂–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å—É–º–º—É –∫–æ–º–∏—Å—Å–∏–∏ –≤ USDT
- Fallback: —Ä–∞—Å—á–µ—Ç –ø–æ MAKER_FEE/TAKER_FEE

#### `process_funding(self)`
- –û—Ü–µ–Ω–∫–∞ funding fee –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤
- –†–∞—Å—á–µ—Ç: `position_size_usd √ó FUNDING_RATE_8H`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

### 14. PnL Audit

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ main_loop (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥):
```python
# –†–∞—Å—á–µ—Ç–Ω—ã–π PnL
calc_pnl = (current_price - avg_price) √ó size √ó side_mult

# –†–µ–∞–ª—å–Ω—ã–π PnL —Å –±–∏—Ä–∂–∏
exchange_pnl = fetch_position()['unrealizedPnl']

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è
diff = abs(calc_pnl - exchange_pnl)
if diff > 5:
    log("‚ö†Ô∏è PnL MISMATCH!")
```

---

### 15. Future Spy (–∞–Ω–∞–ª–∏–∑ —É–ø—É—â–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏)

–ü–æ—Å–ª–µ Stop Loss:
```python
# –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã 30 –º–∏–Ω—É—Ç
track_price_after_close(duration=30min)

# –ï—Å–ª–∏ —Ü–µ–Ω–∞ –ø–æ—à–ª–∞ –≤–≤–µ—Ä—Ö
if price_went_up:
    missed_profit = (peak_price - close_price) √ó size
    log(f"üí∏ –£–ø—É—â–µ–Ω–æ ${missed_profit:.2f}")
```

---

### 16. Telegram Dashboard

#### `update_dashboard(self, force=False)`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ (–∏–ª–∏ force)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - –°—Ç–∞—Ç—É—Å (Active / Pause / In Position)
  - –ë–∞–ª–∞–Ω—Å, PnL —Å–µ—Å—Å–∏–∏
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (wins/losses, winrate)
  - –†—ã–Ω–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (—Ü–µ–Ω–∞, ATR, ADX, —Ä–µ–∂–∏–º)
  - –î–µ—Ç–∞–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å):
    - –°—Ç–æ—Ä–æ–Ω–∞, —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞, —Ä–∞–∑–º–µ—Ä
    - Confluence, —Å—Ç–∞–¥–∏—è
    - Unrealized PnL
    - TP –∏ DCA –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
    - Trailing —Å—Ç–∞—Ç—É—Å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### `send_or_update_trade_message(self, text)`
- –û—Ç–ø—Ä–∞–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–¥–µ–ª–∫–µ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç message_id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: Open, DCA1-5, TP, SL

#### `get_keyboard(self)`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
  - üíº Balance
  - üìä Dashboard
  - ‚è∏ Pause / ‚ñ∂Ô∏è Resume
  - üÜò Panic Sell
  - ü§ñ AI Report

---

### 17. AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### `trigger_ai_report_thread(self, manual=False)`
- –ó–∞–ø—É—Å–∫ AI –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
- –í—Ä—É—á–Ω—É—é: –∫–Ω–æ–ø–∫–∞ –≤ Telegram

#### `_generate_and_send_ai_report(self, manual)`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ Gemini
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ + —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram

#### `trigger_ai_chat_reply(self, user_question)`
- –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ AI
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ø–æ–∑–∏—Ü–∏—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ª–æ–≥–∏

---

### 18. Main Loop

#### `run(self)`
- **–ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ** –±–æ—Ç–∞
- –ß–∞—Å—Ç–æ—Ç–∞: –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥ (–æ–±—ã—á–Ω–æ 5-10)
- –õ–æ–≥–∏–∫–∞:
  ```python
  while True:
      # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞
      df = get_market_data_enhanced()

      # 2. –ï–°–õ–ò –ù–ï–¢ –ü–û–ó–ò–¶–ò–ò
      if not in_position:
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ cooldown
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
          signal = check_entry_signal_hybrid(df)
          if signal:
              open_position(signal)

      # 3. –ï–°–õ–ò –ï–°–¢–¨ –ü–û–ó–ò–¶–ò–Ø
      else:
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∏—Ä–∂–µ–π
          sync_position_with_exchange()

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è TP
          check_tp_execution()

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è DCA
          check_dca_execution()

          # Trailing Stop
          if check_trailing_stop():
              continue

          # Stop Loss (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞!)
          max_loss = balance √ó 0.30
          u_pnl = calculate_unrealized()
          if u_pnl <= -max_loss:
              close_position_market("STOP LOSS -30%")

          # PnL –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
          # Dashboard –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

      # 4. –ü–∞—É–∑–∞
      sleep(LOOP_INTERVAL)
  ```

---

## üì± telegram_bot.py - Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### `TelegramBot.__init__(self, token)`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ handlers –¥–ª—è –∫–æ–º–∞–Ω–¥ –∏ callback

### `send(self, message, keyboard=None)`
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
- HTML —Ä–∞–∑–º–µ—Ç–∫–∞

### `edit_message(self, message_id, new_text, keyboard=None)`
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### `listen_updates(self)`
- –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ callback –∫–Ω–æ–ø–æ–∫
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{'chat_id', 'message_id', 'value'}`

---

## üß† ai_assistant.py - AI –ø–æ–º–æ—â–Ω–∏–∫

### `AIAssistant.__init__(self, api_key, model_name)`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini –∫–ª–∏–µ–Ω—Ç–∞

### `generate_report(self, context)`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

### `chat(self, question, context)`
- –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üîê security.py - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

### `encrypt_config(data, key_file)`
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `encrypted_config.bin`

### `decrypt_config(key_file)`
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ API –∫–ª—é—á–µ–π
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: dict —Å –∫–ª—é—á–∞–º–∏

---

## ‚öôÔ∏è config.py - –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (—Å–º. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ –≤ BOT_LOGIC_DOCUMENTATION.md)

```python
# –ë–∏—Ä–∂–∞
SYMBOL = 'BTC/USDT:USDT'
LEVERAGE = 20

# –í—Ö–æ–¥—ã
STAGE2_BASE_ENTRY = 0.018

# DCA
HAMMER_DISTANCES_TREND = [0.006, 0.012, 0.020, 0.030, 0.045]
HAMMER_WEIGHTS_TREND = [1.4, 2.0, 2.8, 3.5, 4.5]
HAMMER_DISTANCES_RANGE = [0.010, 0.018, 0.030, 0.045, 0.065]
HAMMER_WEIGHTS_RANGE = [1.6, 2.2, 3.0, 4.0, 5.0]

# –ó–∞—â–∏—Ç–∞
MAX_ACCOUNT_LOSS_PCT = 0.30

# Trailing
TRAILING_ACTIVATION_PCT = 0.008
TRAILING_CALLBACK_PCT = 0.0035

# –§–∏–ª—å—Ç—Ä—ã
MIN_VOLATILITY_PCT = 0.0003
RSI_SAFE_MIN = 30
RSI_SAFE_MAX = 70
KNIFE_PROTECTION_PCT = 0.015
MIN_CONFLUENCE_SCORE = 1

# –õ–∏–º–∏—Ç—ã
SAFETY_ORDERS_COUNT = 5
DAILY_TRADE_LIMIT = 150
MIN_TIME_BETWEEN_TRADES = 3600
```

---

## üîë –ö–õ–Æ–ß–ï–í–´–ï –§–û–†–ú–£–õ–´

### 1. Smart Distance Multiplier
```python
multiplier = (ATR / 0.002) √ó RSI_factor √ó (1.1 ^ safety_count)
ATR: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω [0.8, 2.5]
RSI_factor: 1.0 (RSI>40), 1.1 (RSI<40), 1.3 (RSI<30), 1.6 (RSI<20)
```

### 2. Dynamic TP
```python
TP = 0.35% + (ATR √ó 0.5)
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: [0.25%, 1.0%]
```

### 3. –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ DCA
```python
avg_price = (prev_total_usd + dca_usd) / total_size_btc
prev_total_usd = avg_price √ó (total_size_btc - dca_size_btc)
dca_usd = dca_price √ó dca_size_btc
```

### 4. Unrealized PnL
```python
side_mult = 1 (LONG) –∏–ª–∏ -1 (SHORT)
u_pnl = (current_price - avg_price) √ó total_size_btc √ó side_mult
```

### 5. –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è (BingX Cross Margin)
```python
MMR = 0.5%
maintenance_margin = position_size_usd √ó MMR
max_loss_before_liquidation = balance - maintenance_margin

# –¶–µ–Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
liq_price = avg_price - (max_loss / total_size_btc)
```

---

## ‚ö†Ô∏è –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. Stop Loss –æ—Ä–¥–µ—Ä –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ DCA
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ë–∏—Ä–∂–µ–≤–æ–π SL –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ main_loop (—Ä–∞–±–æ—Ç–∞–µ—Ç!)
- **–°—Ç–∞—Ç—É—Å**: –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç.–∫. –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –∑–∞—â–∏—Ç–∞

### 2. SL –æ—Ä–¥–µ—Ä —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Ü–µ–Ω—ã, –∞ –Ω–µ –æ—Ç –±–∞–ª–∞–Ω—Å–∞
- **–ü—Ä–æ–±–ª–µ–º–∞**: `sl_price = avg_price √ó (1 - 0.30)` —ç—Ç–æ -30% –æ—Ç –¶–ï–ù–´
- **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –î–æ–ª–∂–Ω–æ –±—ã—Ç—å -$1,020 –æ—Ç –ø–æ–∑–∏—Ü–∏–∏
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É–ª—É
- **–°—Ç–∞—Ç—É—Å**: –ù–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, SL –æ—Ä–¥–µ—Ä ‚Äî backup

### 3. DCA5 –º–æ–∂–µ—Ç –±—ã—Ç—å –ù–ò–ñ–ï —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
- **–ù–ï –ë–ê–ì!**: –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
- SL —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –†–ê–ù–¨–®–ï —á–µ–º DCA5
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –≤ –ø–∞–¥–∞—é—â–∏–π –Ω–æ–∂

---

## ‚úÖ –ü–†–û–í–ï–†–û–ß–ù–´–ô –°–ü–ò–°–û–ö –î–õ–Ø –ù–û–í–û–ô –°–ï–°–°–ò–ò

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –ø—Ä–æ–≤–µ—Ä—å:

1. ‚úÖ **–í–µ—Ä—Å–∏—è**: v1.4.1 (Hybrid Edition)
2. ‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª**: trading_bot.py (2428 —Å—Ç—Ä–æ–∫, 71KB)
3. ‚úÖ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
   - `get_smart_distance_multiplier()` ‚Äî —É–º–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å DCA
   - `execute_dca()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ DCA
   - `place_limit_tp()` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ DCA
   - `place_stop_loss()` ‚Äî –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (—ç—Ç–æ –Ω–æ—Ä–º–∞!)
   - –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SL –≤ main_loop ‚Äî –†–ê–ë–û–¢–ê–ï–¢
4. ‚úÖ **–†–µ–∂–∏–º—ã**: TREND (ADX > 25) vs RANGE (ADX ‚â§ 25)
5. ‚úÖ **–ë–∏—Ä–∂–∞**: BingX, Cross Margin, leverage 20x
6. ‚úÖ **–ó–∞–ø–∞—Å –ø—Ä–æ—á–Ω–æ—Å—Ç–∏**: 9-23% –æ—Ç –≤—Ö–æ–¥–∞ –¥–æ SL, 11-12% –æ—Ç SL –¥–æ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏

---

**–°–æ–∑–¥–∞–Ω–æ**: 2025-01-23
**–°—Ç–∞—Ç—É—Å**: –ê–∫—Ç—É–∞–ª—å–Ω–æ ‚úÖ
**–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**: –í –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ Claude
