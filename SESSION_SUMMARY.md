# üìã –í–´–ñ–ò–ú–ö–ê –°–ï–°–°–ò–ò: –ê–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ BTC

**–î–∞—Ç–∞:** 2026-01-23
**–í–µ—Ç–∫–∞:** `claude/review-python-code-ebU0y`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üéØ –û–°–ù–û–í–ù–ê–Ø –ó–ê–î–ê–ß–ê

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Python –∫–æ–¥ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ –Ω–∞ –æ—à–∏–±–∫–∏, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–≥–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –ª–æ–≥–∏–∫–∏.

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò

### 1. **–ë–ê–ì: entry_usd_vol –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª `entry_usd_vol` –ø–æ —Ñ–æ—Ä–º—É–ª–µ: `(avg_price √ó total_size) / leverage`
- –≠—Ç–∞ —Ñ–æ—Ä–º—É–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–ï–ö–£–©–£–Æ –ø–æ–∑–∏—Ü–∏—é (–≤–∫–ª—é—á–∞—è —É–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ DCA!)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: DCA3 –±—ã–ª **–≤ 20 —Ä–∞–∑ –±–æ–ª—å—à–µ** —á–µ–º –Ω—É–∂–Ω–æ

**–†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ bag.txt:**
```
–†–µ–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥: $88.41
–ü–æ—Å–ª–µ DCA2 –±–æ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª: $633 (–∏–∑ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏)
DCA3 —Ä–∞—Å—Å—á–∏—Ç–∞–ª—Å—è: $633 √ó 3.0 = $1,901 –≤–º–µ—Å—Ç–æ $88.41 √ó 3.0 = $265
–†–µ–∑—É–ª—å—Ç–∞—Ç: –º–∞—Ä–∂–∞ –≤—ã—Ä–æ—Å–ª–∞ —Å 18% –¥–æ 70% –±–∞–ª–∞–Ω—Å–∞!
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤ 2% –æ—Ç –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `entry_usd_vol` –∏–∑ `blackbox.json` (–ø–æ—Å–ª–µ–¥–Ω–∏–π ENTRY event)
- Fallback: –¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ estimated_total_weight (~4.8)
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è `base_entry_price`

**–§–∞–π–ª:** `trading_bot.py` —Å—Ç—Ä–æ–∫–∏ 1048-1114
**–ö–æ–º–º–∏—Ç:** `e8a6c78`

---

### 2. **–ë–ê–ì: position_side –≤—Å–µ–≥–¥–∞ "Buy" –≤ Hedge —Ä–µ–∂–∏–º–µ**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í BingX Hedge mode –ø–æ–ª–µ `contracts` –≤—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ (–¥–ª—è LONG –∏ SHORT)
- –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª `amt > 0`, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–æ True
- –†–µ–∑—É–ª—å—Ç–∞—Ç: DCA –¥–ª—è SHORT —Å—Ç–∞–≤–∏–ª–∏—Å—å –ù–ò–ñ–ï –≤—Ö–æ–¥–∞ –≤–º–µ—Å—Ç–æ –í–´–®–ï

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –î–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
self.position_side = "Buy" if amt > 0 else "Sell"

# –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
position_side_from_exchange = pos.get('side') or pos['info'].get('positionSide', 'LONG')
self.position_side = "Buy" if position_side_from_exchange.upper() == "LONG" else "Sell"
```

**–§–∞–π–ª:** `trading_bot.py` —Å—Ç—Ä–æ–∫–∏ 1040-1041
**–ö–æ–º–º–∏—Ç:** `e3cad00`

---

### 3. **–ë–ê–ì: reduceOnly –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ BingX Hedge mode**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- BingX Hedge mode –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `reduceOnly`
- TP –æ—Ä–¥–µ—Ä–∞ –ø–∞–¥–∞–ª–∏ —Å –æ—à–∏–±–∫–æ–π: `{"code":109400,"msg":"In the Hedge mode, the 'ReduceOnly' field can not be filled."}`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `reduceOnly` –∏–∑ TP –æ—Ä–¥–µ—Ä–æ–≤
- –£–¥–∞–ª–µ–Ω –∏–∑ market close –æ—Ä–¥–µ—Ä–æ–≤
- BingX –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç closing –æ—Ä–¥–µ—Ä –ø–æ `positionSide`

**–§–∞–π–ª:** `trading_bot.py` —Å—Ç—Ä–æ–∫–∏ 1316-1325, 1487-1494
**–ö–æ–º–º–∏—Ç:** `e3cad00`

---

### 4. **–ë–ê–ì: PnL mismatch –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ side_mult**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò–∑-–∑–∞ –±–∞–≥–∞ #2 `side_mult` –≤—Å–µ–≥–¥–∞ –±—ã–ª 1
- PnL —Ä–∞—Å—á–µ—Ç—ã –±—ã–ª–∏ –Ω–µ—Ç–æ—á–Ω—ã–º–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–∞ #2

---

## üîç –ê–ù–ê–õ–ò–ó –†–ï–ê–õ–¨–ù–û–ì–û –ü–û–í–ï–î–ï–ù–ò–Ø BTC

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–¥–µ–ª–∫–∞ –∏–∑ bag.txt:
```
–í—Ö–æ–¥ LONG @ 90,330: $88.41
DCA1 @ 89,896 (-0.48%): $123
DCA2 @ 89,125 (-1.06%): $422
DCA3 @ 87,535 (-2.13%): $1,774 ‚Üê –ë–ê–ì! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å $265

–†–µ–∑—É–ª—å—Ç–∞—Ç —Å –±–∞–≥–æ–º:
- –ú–∞—Ä–∂–∞: $2,408 (70.8% –±–∞–ª–∞–Ω—Å–∞)
- –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è: 83,847 (-7.18% –æ—Ç –≤—Ö–æ–¥–∞)
- –ó–∞–ø–∞—Å –¥–æ –ª–∏–∫–∏: 2%

–†–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ –±–∞–≥–∞:
- –ú–∞—Ä–∂–∞: $203 (6% –±–∞–ª–∞–Ω—Å–∞)
- –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è: 85,084 (-5.81% –æ—Ç –≤—Ö–æ–¥–∞)
- –ó–∞–ø–∞—Å –¥–æ –ª–∏–∫–∏: 5.3%
```

### –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä:
```
–ë–∞–∑–æ–≤—ã–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ RANGE: [1.0%, 1.8%, 3.0%]
–†–µ–∞–ª—å–Ω—ã–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏: [0.48%, 1.06%, 2.13%]
–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä: 0.59x (–¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–∂–∞–ª–∏—Å—å –≤ 1.7 —Ä–∞–∑–∞!)

–ü—Ä–∏—á–∏–Ω–∞: –ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (ATR < 0.0015)
```

---

## ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –°—Ç–æ–ø-–ª–æ—Å—Å –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!

### –ü—Ä–æ–±–ª–µ–º–∞:
–°—Ç–æ–ø-–ª–æ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ **-30% –ë–ê–õ–ê–ù–°–ê** = **-$1,020**

–ù–æ –ø—Ä–∏ –º–∞—Ä–∂–∞—Ö 1-3% –±–∞–ª–∞–Ω—Å–∞:
- **–õ–∏–∫–≤–∏–¥–∞—Ü–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —É–±—ã—Ç–∫–µ **-1-3% –±–∞–ª–∞–Ω—Å–∞** (-$30-100)
- **–°—Ç–æ–ø-–ª–æ—Å—Å** —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —É–±—ã—Ç–∫–µ **-30% –±–∞–ª–∞–Ω—Å–∞** (-$1,020)

**–õ–ò–ö–í–ò–î–ê–¶–ò–Ø –†–ê–ù–¨–®–ï –°–¢–û–ü-–õ–û–°–°–ê!** ‚ùå

### –ü—Ä–∏–º–µ—Ä (–ø–æ—Å–ª–µ DCA4):
```
–ú–∞—Ä–∂–∞: $52 (1.5% –±–∞–ª–∞–Ω—Å–∞)
–õ–∏–∫–≤–∏–¥–∞—Ü–∏—è: –ø—Ä–∏ —É–±—ã—Ç–∫–µ -$50 ‚Üí —Ü–µ–Ω–∞ $84,625 (-6.32%)
–°—Ç–æ–ø-–ª–æ—Å—Å: –ø—Ä–∏ —É–±—ã—Ç–∫–µ -$1,020 ‚Üí —Ü–µ–Ω–∞ $1,979 (-97%!)
```

### –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- **–í–∞—Ä–∏–∞–Ω—Ç –ê:** % –æ—Ç –º–∞—Ä–∂–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -80% –º–∞—Ä–∂–∏)
- **–í–∞—Ä–∏–∞–Ω—Ç –ë:** % –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -10% –æ—Ç entry_price)

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –õ–∏–º–∏—Ç –º–∞—Ä–∂–∏ –∫–∞–∫ –∑–∞—â–∏—Ç–∞

–í–º–µ—Å—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ DCA, –¥–æ–±–∞–≤–∏—Ç—å **–ª–∏–º–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –º–∞—Ä–∂–∏:**

```python
MAX_MARGIN_PCT = 0.50  # 50% –±–∞–ª–∞–Ω—Å–∞ –º–∞–∫—Å–∏–º—É–º

def should_place_dca(self, dca_size_usd):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º DCA"""
    current_margin = self.get_current_margin_usd()
    new_margin = current_margin + (dca_size_usd / self.leverage)

    if new_margin / self.balance > MAX_MARGIN_PCT:
        self.log(f"‚ö†Ô∏è DCA –æ—Ç–º–µ–Ω–µ–Ω–∞: –º–∞—Ä–∂–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç {MAX_MARGIN_PCT*100}%", Col.YELLOW)
        return False
    return True
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ DCA1-4 –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è (–º–∞—Ä–∂–∞ –æ–±—ã—á–Ω–æ 30-40%)
- ‚úÖ DCA5 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∞ –º–∞—Ä–∂–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è

---

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í –ò –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê

### üîß config.py (121 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±–æ—Ç–∞

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
SYMBOL = 'BTC/USDT:USDT'
TIMEFRAME = '1m'
LEVERAGE = 20

# –†–∞–∑–º–µ—Ä—ã –≤—Ö–æ–¥–∞ –ø–æ —Å—Ç–∞–¥–∏—è–º
STAGE1_MIN_ENTRY = 0.008  # 0.8%
STAGE1_BASE_ENTRY = 0.012  # 1.2%
STAGE1_MAX_ENTRY = 0.016  # 1.6%

STAGE2_MIN_ENTRY = 0.013
STAGE2_BASE_ENTRY = 0.018
STAGE2_MAX_ENTRY = 0.023

STAGE3_MIN_ENTRY = 0.018
STAGE3_BASE_ENTRY = 0.025
STAGE3_MAX_ENTRY = 0.030

# DCA —Å–µ—Ç–∫–∞
SAFETY_ORDERS_COUNT = 5
HAMMER_DISTANCES_TREND = [0.006, 0.012, 0.020, 0.030, 0.045]
HAMMER_DISTANCES_RANGE = [0.010, 0.018, 0.030, 0.045, 0.065]
HAMMER_WEIGHTS_TREND = [1.4, 2.0, 2.8, 3.5, 4.5]
HAMMER_WEIGHTS_RANGE = [1.6, 2.2, 3.0, 4.0, 5.0]

# Trailing Stop
TRAILING_ENABLED = True
TRAILING_ACTIVATION_PCT = 0.0080  # +0.8%
TRAILING_CALLBACK_PCT = 0.0035    # -0.35%

# –ó–∞—â–∏—Ç–∞
MAX_ACCOUNT_LOSS_PCT = 0.30  # 30% –±–∞–ª–∞–Ω—Å–∞ (–ù–ï –†–ê–ë–û–¢–ê–ï–¢!)

# –§–∏–ª—å—Ç—Ä—ã
MIN_VOLATILITY_PCT = 0.0003
RSI_SAFE_MIN = 30
RSI_SAFE_MAX = 70
MIN_CONFLUENCE_SCORE = 1
```

---

### ü§ñ trading_bot.py (1643 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞

#### **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**

**`__init__()`** (—Å—Ç—Ä–æ–∫–∏ 14-80)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∏—Ä–∂–µ
- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–µ—á–∞

**`run()`** (—Å—Ç—Ä–æ–∫–∏ 82-117)
- –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –±–æ—Ç–∞
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
- –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏

#### **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è**

**`sync_with_exchange()`** (—Å—Ç—Ä–æ–∫–∏ 1022-1152)
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
- **–ö–†–ò–¢–ò–ß–ù–û:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ entry_usd_vol –∏ base_entry_price –∏–∑ blackbox.json
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ position_side (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥)
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ safety_count, avg_price, total_size_coins
- –ü–µ—Ä–µ—Å—á–µ—Ç DCA –∏ TP –æ—Ä–¥–µ—Ä–æ–≤

#### **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

**`get_market_data()`** (—Å—Ç—Ä–æ–∫–∏ 119-226)
- –ó–∞–≥—Ä—É–∑–∫–∞ OHLCV –¥–∞–Ω–Ω—ã—Ö —Å –±–∏—Ä–∂–∏
- –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: EMA9, EMA20, EMA50, ATR, RSI, ADX
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ DataFrame
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ market_hybrid.csv

#### **–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ —Å–∏–≥–Ω–∞–ª—ã**

**`calculate_confluence(signal_side)`** (—Å—Ç—Ä–æ–∫–∏ 228-324)
- –†–∞—Å—á–µ—Ç confluence score (0-7 –±–∞–ª–ª–æ–≤)
- 7 —Ñ–∏–ª—å—Ç—Ä–æ–≤:
  1. RSI (LONG: 30-50, SHORT: 50-70)
  2. EMA trend (—Ü–µ–Ω–∞ vs EMA9/20)
  3. Volume surge (–æ–±—ä–µ–º > —Å—Ä–µ–¥–Ω–µ–≥–æ)
  4. ATR check (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è)
  5. ADX strength (—Ç—Ä–µ–Ω–¥ —Å–∏–ª—å–Ω—ã–π)
  6. Candle pattern (–±—ã—á—å—è/–º–µ–¥–≤–µ–∂—å—è —Å–≤–µ—á–∞)
  7. Knife protection (–Ω–µ—Ç –ø–∞–Ω–∏–∫–∏)

**`determine_stage(confluence)`** (—Å—Ç—Ä–æ–∫–∏ 326-338)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –≤—Ö–æ–¥–∞ (1, 2, 3) –ø–æ confluence score
- Stage 1: confluence 0-2
- Stage 2: confluence 3-4
- Stage 3: confluence 5+

**`calculate_entry_size(stage, confluence, side)`** (—Å—Ç—Ä–æ–∫–∏ 340-390)
- –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤—Ö–æ–¥–∞ –≤ % –æ—Ç –±–∞–ª–∞–Ω—Å–∞
- –£—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞–¥–∏—é, confluence, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç % –æ—Ç –±–∞–ª–∞–Ω—Å–∞ (0.008-0.030)

**`get_trade_signal()`** (—Å—Ç—Ä–æ–∫–∏ 392-459)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –≤—Ö–æ–¥–∞
- Confluence >= MIN_CONFLUENCE_SCORE
- EMA trend: EMA9 > EMA20 (LONG), EMA9 < EMA20 (SHORT)
- Cooldown check
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: ('Buy'/'Sell', confluence, stage) –∏–ª–∏ (None, 0, 0)

#### **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è DCA —Å–µ—Ç–∫–∞**

**`get_smart_distance_multiplier(safety_count)`** (—Å—Ç—Ä–æ–∫–∏ 461-484)
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–π DCA**
- –§–æ—Ä–º—É–ª–∞: `atr_factor √ó rsi_factor √ó geo_factor`

  **atr_factor** (0.8x - 2.5x):
  ```python
  BASE_ATR = 0.0020
  atr_factor = current_volatility / BASE_ATR
  atr_factor = clamp(0.8, 2.5)
  ```

  **rsi_factor** (1.0x - 1.6x):
  ```python
  if LONG:
      RSI < 20: 1.6x  # –ü–∞–Ω–∏–∫–∞ - —Ä–∞—Å—à–∏—Ä–∏—Ç—å
      RSI < 30: 1.3x
      RSI < 40: 1.1x
      –ò–Ω–∞—á–µ: 1.0x
  ```

  **geo_factor**:
  ```python
  geo_factor = 1.1 ^ safety_count  # –ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è
  ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–∂–∏–º–∞—é—Ç—Å—è/—Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ RSI

#### **–í—Ö–æ–¥ –≤ –ø–æ–∑–∏—Ü–∏—é**

**`open_position(side, confluence, stage)`** (—Å—Ç—Ä–æ–∫–∏ 486-633)
- –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –≤—Ö–æ–¥
- –û—Ç–º–µ–Ω–∞ –∏ retry –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ blackbox.json

**`execute_entry(fill_price, size_coins, order_id, confluence, stage, side, vol_usd)`** (—Å—Ç—Ä–æ–∫–∏ 635-788)
- –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏:
  - `entry_price`, `avg_price`
  - `base_entry_price` (–¥–ª—è DCA —Ä–∞—Å—á–µ—Ç–æ–≤)
  - `entry_usd_vol` (–¥–ª—è –≤–µ—Å–æ–≤ DCA)
  - `total_size_coins`
  - `position_side`
- –ó–∞–ø—É—Å–∫ DCA –∏ TP
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ENTRY –≤ blackbox.json

#### **DCA –ª–æ–≥–∏–∫–∞**

**`place_limit_dca()`** (—Å—Ç—Ä–æ–∫–∏ 1296-1407)
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ DCA –æ—Ä–¥–µ—Ä–∞
- **–†–∞—Å—á–µ—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏:**
  ```python
  # –ë–∞–∑–æ–≤–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
  if ADX > 25:  # TREND
      base_dist = HAMMER_DISTANCES_TREND[safety_count]
  else:  # RANGE
      base_dist = HAMMER_DISTANCES_RANGE[safety_count]

  # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä
  multiplier = get_smart_distance_multiplier(safety_count)

  # –†–µ–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
  actual_dist = base_dist * multiplier

  # –¶–µ–Ω–∞ DCA
  if LONG:
      dca_price = base_entry_price * (1 - actual_dist)
  else:  # SHORT
      dca_price = base_entry_price * (1 + actual_dist)
  ```

- **–†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ DCA:**
  ```python
  # –ë–∞–∑–æ–≤—ã–π –≤–µ—Å
  if ADX > 25:  # TREND
      weight = HAMMER_WEIGHTS_TREND[safety_count]
  else:  # RANGE
      weight = HAMMER_WEIGHTS_RANGE[safety_count]

  # Volume factor (knife protection)
  volume_factor = 1.0
  if LONG and RSI < 20:
      volume_factor = 0.8  # -20% –ø—Ä–∏ –ø–∞–Ω–∏–∫–µ
  elif LONG and RSI < 30:
      volume_factor = 0.9  # -10%

  # –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä
  dca_vol_usd = entry_usd_vol * weight * volume_factor
  dca_size_coins = dca_vol_usd / dca_price
  ```

**`execute_dca(fill_price, size_coins, order_id)`** (—Å—Ç—Ä–æ–∫–∏ 790-959)
- –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ DCA –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `avg_price`, `total_size_coins`
- –ü–µ—Ä–µ—Å—á–µ—Ç –º–∞—Ä–∂–∏
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `safety_count`
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ DCA (–µ—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ TP
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ DCA_EXECUTED –≤ blackbox.json

#### **Take Profit –ª–æ–≥–∏–∫–∞**

**`calculate_dynamic_tp()`** (—Å—Ç—Ä–æ–∫–∏ 961-991)
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TP –æ—Ç ATR:**
  ```python
  base_tp = 0.0035  # 0.35%
  atr_bonus = current_volatility * 0.5
  tp_pct = clamp(base_tp + atr_bonus, 0.0025, 0.0100)
  ```

**`place_limit_tp()`** (—Å—Ç—Ä–æ–∫–∏ 1268-1294)
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–Ω–æ–≥–æ TP –æ—Ä–¥–µ—Ä–∞
- **–ë–ï–ó reduceOnly** (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥)
- –ü–∞—Ä–∞–º–µ—Ç—Ä `positionSide` –¥–ª—è Hedge mode

#### **Trailing Stop –ª–æ–≥–∏–∫–∞**

**`update_trailing_stop()`** (—Å—Ç—Ä–æ–∫–∏ 1409-1485)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ trailing stop
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è: PnL > +0.8%
- Callback: -0.35% –æ—Ç –ø–∏–∫–∞
- –ó–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ market –æ—Ä–¥–µ—Ä

#### **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏**

**`close_position_market(reason)`** (—Å—Ç—Ä–æ–∫–∏ 1487-1567)
- –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ market –æ—Ä–¥–µ—Ä–æ–º
- –û—Ç–º–µ–Ω–∞ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (DCA, TP)
- –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–≥–æ PnL
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (TP_HIT, STOP_LOSS, MANUAL_CLOSE)
- –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–∏
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cooldown (–µ—Å–ª–∏ —É–±—ã—Ç–æ–∫)

#### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**`log(msg, color)`** (—Å—Ç—Ä–æ–∫–∏ 1569-1580)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–∞–º–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –∏ —Ñ–∞–π–ª

**`log_blackbox(event, data)`** (—Å—Ç—Ä–æ–∫–∏ 1582-1595)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ blackbox.json
- –°–æ–±—ã—Ç–∏—è: ENTRY, DCA_EXECUTED, TP_HIT, STOP_LOSS, PNL_MISMATCH
- **–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞!**

#### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–∏**

**`monitor_position()`** (—Å—Ç—Ä–æ–∫–∏ 1597-1688)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ä–¥–µ—Ä–æ–≤ (DCA, TP)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ trailing stop
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞** (–ù–ï –†–ê–ë–û–¢–ê–ï–¢ - —Å–º. –ø—Ä–æ–±–ª–µ–º—É –≤—ã—à–µ)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
- PnL audit (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ PnL —Å –±–∏—Ä–∂–µ–≤—ã–º)

---

### üí¨ telegram_bot.py (398 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** Telegram –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

**`send_trade_notification(data)`** (—Å—Ç—Ä–æ–∫–∏ ~50-100)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–¥–µ–ª–∫–∞—Ö
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å emoji –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

**`handle_message(update, context)`** (—Å—Ç—Ä–æ–∫–∏ ~150-250)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥: /start, /status, /stats, /stop
- AI —á–∞—Ç —á–µ—Ä–µ–∑ Gemini API

**`ask_ai(question)`** (—Å—Ç—Ä–æ–∫–∏ ~300-350)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gemini 2.0 Flash
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –∏—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫, —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è

---

### ü§ñ ai_assistant.py (156 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** AI –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ —á–µ—Ä–µ–∑ Gemini

**`analyze_market_with_ai(df, current_position)`**
- –ê–Ω–∞–ª–∏–∑ DataFrame —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—Ö–æ–¥—É/–≤—ã—Ö–æ–¥—É
- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏

---

### üîê security.py (68 —Å—Ç—Ä–æ–∫)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞

**`generate_key()`** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ Fernet
**`encrypt_config(config_dict, key)`** - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
**`decrypt_config(encrypted_data, key)`** - –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞

---

### üöÄ main.py (42 —Å—Ç—Ä–æ–∫–∏)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞

```python
if __name__ == "__main__":
    bot = TradingBot()

    # –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    telegram_thread = threading.Thread(target=run_telegram_bot, args=(bot,))
    telegram_thread.start()

    # –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞
    bot.run()
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–û–î–ê

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –§—É–Ω–∫—Ü–∏–π | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|---------|------------|
| **trading_bot.py** | 1643 | ~25 | –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ |
| **config.py** | 121 | 0 | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
| **telegram_bot.py** | 398 | ~8 | Telegram –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |
| **ai_assistant.py** | 156 | 2 | AI –∞–Ω–∞–ª–∏–∑ |
| **security.py** | 68 | 3 | –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| **main.py** | 42 | 1 | –ó–∞–ø—É—Å–∫ |
| **–ò–¢–û–ì–û** | **2428** | **~39** | |

---

## üîë –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ë–û–¢–ê

### 1. **–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—Ö–æ–¥–∞ (3 —Å—Ç–∞–¥–∏–∏)**
- Stage 1 (0.8-1.6%): –°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª (confluence 0-2)
- Stage 2 (1.3-2.3%): –°—Ä–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª (confluence 3-4)
- Stage 3 (1.8-3.0%): –°–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª (confluence 5+)

### 2. **7-—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ confluence**
1. RSI –∑–æ–Ω—ã
2. EMA —Ç—Ä–µ–Ω–¥
3. Volume surge
4. ATR check
5. ADX strength
6. Candle pattern
7. Knife protection

### 3. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è DCA —Å–µ—Ç–∫–∞**
- –î–∏—Å—Ç–∞–Ω—Ü–∏–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç ATR –∏ RSI
- –ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä: 0.5x - 5.0x
- –í–µ—Å–∞ —Å–Ω–∏–∂–∞—é—Ç—Å—è –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö RSI (knife protection)

### 4. **–î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏**
- **TREND** (ADX > 25): –£–∑–∫–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, –ª–µ–≥–∫–∏–µ –≤–µ—Å–∞
- **RANGE** (ADX ‚â§ 25): –®–∏—Ä–æ–∫–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, —Ç—è–∂–µ–ª—ã–µ –≤–µ—Å–∞

### 5. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TP**
- –ë–∞–∑–æ–≤—ã–π: 0.35%
- –ë–æ–Ω—É—Å –æ—Ç ATR: +0.5 √ó ATR
- –î–∏–∞–ø–∞–∑–æ–Ω: 0.25% - 1.0%

### 6. **Trailing Stop**
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è: +0.8% –ø—Ä–æ—Ñ–∏—Ç–∞
- Callback: -0.35% –æ—Ç –ø–∏–∫–∞

### 7. **PnL-based Cooldown**
- –ü–æ—Å–ª–µ –ø—Ä–∏–±—ã–ª–∏: –ë–ï–ó cooldown
- –ü–æ—Å–ª–µ —É–±—ã—Ç–∫–∞: 1 —á–∞—Å cooldown

### 8. **Blackbox –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- JSON events –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
- –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã!

---

## üö® –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–†–ê–ë–û–¢–ö–ê

### ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –°—Ç–æ–ø-–ª–æ—Å—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (config.py —Å—Ç—Ä–æ–∫–∞ 80)
MAX_ACCOUNT_LOSS_PCT = 0.30  # -30% –±–∞–ª–∞–Ω—Å–∞

# –í trading_bot.py (—Å—Ç—Ä–æ–∫–∏ 1640-1645)
max_loss = balance * MAX_ACCOUNT_LOSS_PCT  # -$1,020
if u_pnl <= -max_loss:
    close_position_market("STOP LOSS")
```

**–ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —É–±—ã—Ç–∫–µ = 95% –º–∞—Ä–∂–∏
- –ü—Ä–∏ –º–∞—Ä–∂–∞—Ö 1-3% –±–∞–ª–∞–Ω—Å–∞: –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —É–±—ã—Ç–∫–µ -$30-100
- –°—Ç–æ–ø-–ª–æ—Å—Å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —É–±—ã—Ç–∫–µ -$1,020
- **–õ–ò–ö–í–ò–î–ê–¶–ò–Ø –ü–†–û–ò–°–•–û–î–ò–¢ –†–ê–ù–¨–®–ï!**

**–í–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç A: % –æ—Ç –º–∞—Ä–∂–∏**
```python
def check_stop_loss(self):
    current_margin = self.get_current_margin_usd()
    max_loss_from_margin = current_margin * 0.80  # -80% –º–∞—Ä–∂–∏ (–¥–æ –ª–∏–∫–∏ 95%)

    side_mult = 1 if self.position_side == "Buy" else -1
    u_pnl = (self.last_price - self.avg_price) * self.total_size_coins * side_mult

    if u_pnl <= -max_loss_from_margin:
        self.close_position_market(f"STOP LOSS -80% margin")
```

**–í–∞—Ä–∏–∞–Ω—Ç B: % –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞**
```python
STOP_LOSS_FROM_ENTRY_PCT = 0.10  # -10% –æ—Ç –≤—Ö–æ–¥–∞

def check_stop_loss(self):
    if self.position_side == "Buy":
        sl_price = self.entry_price * (1 - STOP_LOSS_FROM_ENTRY_PCT)
        if self.last_price <= sl_price:
            self.close_position_market(f"STOP LOSS -10% from entry")
    else:
        sl_price = self.entry_price * (1 + STOP_LOSS_FROM_ENTRY_PCT)
        if self.last_price >= sl_price:
            self.close_position_market(f"STOP LOSS -10% from entry")
```

---

### ‚úÖ –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û: –õ–∏–º–∏—Ç –º–∞—Ä–∂–∏

–î–æ–±–∞–≤–∏—Ç—å –≤ `trading_bot.py` –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º DCA:

```python
MAX_MARGIN_PCT = 0.50  # 50% –±–∞–ª–∞–Ω—Å–∞

def should_place_dca(self, dca_size_usd):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º DCA"""
    current_margin_usd = sum([
        self.entry_usd_vol / self.leverage,
        # + –≤—Å–µ —É–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ DCA
    ])

    new_margin = current_margin_usd + (dca_size_usd / self.leverage)
    margin_pct = new_margin / self.balance

    if margin_pct > MAX_MARGIN_PCT:
        self.log(f"‚ö†Ô∏è DCA –æ—Ç–º–µ–Ω–µ–Ω–∞: –º–∞—Ä–∂–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç {MAX_MARGIN_PCT*100}%", Col.YELLOW)
        return False

    return True

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ place_limit_dca():
if not self.should_place_dca(dca_vol_usd):
    return
```

---

## üìà –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –†–ò–°–ö–ò

### ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å –≤—ã—Ö–æ–¥–∞:
- **–ü—Ä–∏ –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏** (mult 0.5x): 20-40 –º–∏–Ω—É—Ç
- **–ü—Ä–∏ —Å—Ä–µ–¥–Ω–µ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏** (mult 1.0x): 30-60 –º–∏–Ω—É—Ç
- **–ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏** (mult 2.0x): 40-90 –º–∏–Ω—É—Ç

### ‚ö†Ô∏è –†–∏—Å–∫ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏:
**–ë–ï–ó –ë–ê–ì–ê (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏):**
- –ü–æ—Å–ª–µ DCA1-2: –º–∞—Ä–∂–∞ 0.3-0.6%, –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –Ω–∞ -5% ‚úÖ
- –ü–æ—Å–ª–µ DCA3-4: –º–∞—Ä–∂–∞ 1.0-1.5%, –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –Ω–∞ -6% ‚úÖ
- –ü–æ—Å–ª–µ DCA5: –º–∞—Ä–∂–∞ 2.2%, –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –Ω–∞ -8% üü°

**–° –ë–ê–ì–û–ú (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è):**
- –ü–æ—Å–ª–µ DCA3: –º–∞—Ä–∂–∞ 70%, –ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –Ω–∞ -7% üî¥ –û–ü–ê–°–ù–û!

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–Ω–µ–≥:
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é (–≤–µ—Ç–∫–∞ `claude/review-python-code-ebU0y`)
2. ‚úÖ –ù–∞—á–Ω–∏ —Å Stage 1 (0.8-1.2% –≤—Ö–æ–¥)
3. ‚úÖ –¢–æ—Ä–≥—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ATR > 0.0020 (—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
4. ‚úÖ –î–æ–±–∞–≤—å –ª–∏–º–∏—Ç –º–∞—Ä–∂–∏ 50%
5. ‚úÖ **–ò–°–ü–†–ê–í–¨ –°–¢–û–ü-–õ–û–°–°** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
6. ‚úÖ –ü–æ—Å—Ç–∞–≤—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ -5% –∏ -7% –æ—Ç –≤—Ö–æ–¥–∞
7. ‚úÖ –ù–ï —Ä–µ—Å—Ç–∞—Ä—Ç—É–π –±–æ—Ç–∞ —Å –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–µ–π –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
8. ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π blackbox.json (–¥–æ–ª–∂–µ–Ω –ø–æ–ø–æ–ª–Ω—è—Ç—å—Å—è)

---

## üîÑ GIT –°–¢–ê–¢–£–°

**–í–µ—Ç–∫–∞:** `claude/review-python-code-ebU0y`
**–°—Ç–∞—Ç—É—Å:** Clean, –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—à–µ–Ω—ã

**–ö–æ–º–º–∏—Ç—ã:**
```
e8a6c78 - Fix critical DCA volume bug after restart
e3cad00 - Fix critical bugs in trading bot (position_side, reduceOnly)
0974917 - Adopt best practices from ultrabtc7: volume factor & PnL-based cooldown
```

**–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —ç—Ç—É –≤–µ—Ç–∫—É:**
```bash
git checkout claude/review-python-code-ebU0y
git pull origin claude/review-python-code-ebU0y
```

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å entry_usd_vol (20x DCA)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å position_side –¥–ª—è Hedge mode
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å reduceOnly (TP –æ—à–∏–±–∫–∞ 109400)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å PnL mismatch
- [x] –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ BTC –∏–∑ –ª–æ–≥–æ–≤
- [x] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∫–∏
- [x] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—à–µ–Ω—ã
- [ ] **TODO: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–æ–ø-–ª–æ—Å—Å –ª–æ–≥–∏–∫—É** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- [ ] **TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç –º–∞—Ä–∂–∏** (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

---

## üéì –í–´–í–û–î–´

1. **–ë–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –±–æ—Ç —Ä–∞–±–æ—á–∏–π!** –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.

2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.** –ü—Ä–∏ –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–∂–∏–º–∞—é—Ç—Å—è, –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è.

3. **–°—Ç–æ–ø-–ª–æ—Å—Å –ù–ï –†–ê–ë–û–¢–ê–ï–¢!** –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–µ–π.

4. **–õ–∏–º–∏—Ç –º–∞—Ä–∂–∏** - –ø—Ä–æ—Å—Ç–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∞ –ø–æ–∑–∏—Ü–∏–∏.

5. **–ù–µ –º–µ–Ω—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ DCA –∏ –≤–µ—Å–∞** - –æ–Ω–∏ –ø–æ–¥–æ–±—Ä–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –±–∞–≥–µ, –∞ –Ω–µ –≤ –ª–æ–≥–∏–∫–µ.

---

**–ö–æ–Ω–µ—Ü –≤—ã–∂–∏–º–∫–∏**
